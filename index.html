<!DOCTYPE html>
<html lang="es">

<head>
    <title>Interactive Consumption Data Graphs</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
        integrity="sha384-ZenhHNheleSxlOgEv/zJCfx93gwEpIAoYl’sCWTyctwd+4tQlgoUSvHhvz3kCTxDQ=“ crossorigin=" anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERHp6SiEMe66ANoQxRnfnct7tTznSlAprCdBGLwJQo’eSJ+T4tC++V9Cs syIrto4=“ crossorigin="
        anonymous"></script>
</head>

<body>
    <div style="height:5vh"></div>
    <h1 style="text-align:center">Interactive Consumption Data Graphs</h1>
    <div style="height:5vh"></div>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" id="pills-energy-tab" data-bs-toggle="pill" href="#pills-energy" role="tab"
                aria-controls="pills-energy" aria-selected="true">Consumo de Energia</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-reactive-energy-tab" data-bs-toggle="pill" href="#pills-reactive-energy"
                role="tab" aria-controls="pills-reactive-energy" aria-selected="false">Energia Reactiva</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-power-tab" data-bs-toggle="pill" href="#pills-power" role="tab"
                aria-controls="pills-power" aria-selected="false">Potencia</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-maximeter-tab" data-bs-toggle="pill" href="#pills-maximeter" role="tab"
                aria-controls="pills-maximeter" aria-selected="false">Maximetro</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-reactive-power-tab" data-bs-toggle="pill" href="#pills-reactive-power"
                role="tab" aria-controls="pills-reactive-power" aria-selected="false">Potencia Reactiva</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-voltage-tab" data-bs-toggle="pill" href="#pills-voltage" role="tab"
                aria-controls="pills-voltage" aria-selected="false">Voltaje</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-intensity-tab" data-bs-toggle="pill" href="#pills-intensity" role="tab"
                aria-controls="pills-intensity" aria-selected="false">Intensdad</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-power-factor-tab" data-bs-toggle="pill" href="#pills-power-factor" role="tab"
                aria-controls="pills-power-factor" aria-selected="false">Factor Potencial</a>
        </li>
    </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-energy" role="tabpanel" aria-labelledby="pills-energy-tab">
            <div id="energy-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-reactive-energy" role="tabpanel"
            aria-labelledby="pills-reactive-energy-tab">
            <div id="reactive-energy-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-power" role="tabpanel" aria-labelledby="pills-power-tab">
            <div id="power-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-maximeter" role="tabpanel" aria-labelledby="pills-maximeter-tab">
            <div id="maximeter-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-reactive-power" role="tabpanel" aria-labelledby="pills-reactive-power-tab">
            <div id="reactive-power-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-voltage" role="tabpanel" aria-labelledby="pills-voltage-tab">
            <div id="voltage-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-intensity" role="tabpanel" aria-labelledby="pills-intensity-tab">
            <div id="intensity-graph"></div>
        </div>
        <div class="tab-pane fade" id="pills-power-factor" role="tabpanel" aria-labelledby="pills-power-factor-tab">
            <div id="power-factor-graph"></div>
        </div>
    </div>
    <div class="my-3 mx-5 px-4" style="width:35%">
        <h2>Agregar Registro</h2>
        <form action="/registros" method="post" id="nuevoRegistro">
            <div class="mb-2">
                <label for="dateTimeInput">Fecha y hora:</label>
                <input type="datetime-local" id="dateTimeInput" name="Date" required>
            </div>
            <div class="mb-2">
                <label for="Energy_kWh" class="form-label">Energia (kWh)</label>
                <input type="number" class="form-control" id="energy" name="Energy_kWh" step="0.001" required>
            </div>
            <div class="mb-2">
                <label for="Reactive_energy_kVArh" class="form-label">Energia Reactiva (kVArh)</label>
                <input type="number" class="form-control" id="reactive_energy" name="Reactive_energy_kVArh" step="0.001"
                    required>
            </div>
            <div class="mb-2">
                <label for="Power_kW" class="form-label">Potencia (kW)</label>
                <input type="number" class="form-control" id="power" name="Power_kW" step="0.001" required>
            </div>
            <div class="mb-2">
                <label for="Maximeter_kW" class="form-label">Maximetro (kW)</label>
                <input type="number" class="form-control" id="maximeter" name="Maximeter_kW" step="0.001" required>
            </div>
            <div class="mb-2">
                <label for="Reactive_power_kVAr" class="form-label">Potencia Reactiva (kVAr)</label>
                <input type="number" class="form-control" id="reactive_power" name="Reactive_power_kVAr" step="0.001"
                    required>
            </div>
            <div class="mb-2">
                <label for="Voltage_V" class="form-label">Voltaje (V)</label>
                <input type="number" class="form-control" id="voltage" name="Voltage_V" step="0.001" required>
            </div>
            <div class="mb-2">
                <label for="Intensity_A" class="form-label">Intensidad (A)</label>
                <input type="number" class="form-control" id="intensity" name="Intensity_A" step="0.001" required>
            </div>
            <div class="mb-2">
                <label for="Power_factor" class="form-label">Factor Potencial ("φ")</label>
                <input type="number" class="form-control" id="power_factor" name="Power_factor" step="0.001" required>
            </div>
            <button id="submit-button" type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>

    <script>
        const formulario = document.querySelector("#nuevoRegistro");
        formulario.addEventListener("submit", function (e) {
            e.preventDefault();
            const dateTimeInput = document.querySelector("#dateTimeInput").value;
            const selectedDate = new Date(dateTimeInput);
            const formattedDate = formatDateTime(selectedDate);
            const energy = parseFloat(document.getElementById('energy').value);
            const reactive_energy = parseFloat(document.getElementById('reactive_energy').value);
            const power = parseFloat(document.getElementById('power').value);
            const maximeter = parseFloat(document.getElementById('maximeter').value);
            const reactive_power = parseFloat(document.getElementById('reactive_power').value);
            const voltage = parseFloat(document.getElementById('voltage').value);
            const intensity = parseFloat(document.getElementById('intensity').value);
            const power_factor = parseFloat(document.getElementById('power_factor').value);

            const registroData = {
                "Date": formattedDate,
                "Energy_kWh": energy,
                "Reactive_energy_kVArh": reactive_energy,
                "Power_kW": power,
                "Maximeter_kW": maximeter,
                "Reactive_power_kVAr": reactive_power,
                "Voltage_V": voltage,
                "Intensity_A": intensity,
                "Power_factor": power_factor
            };

            fetch('/registros', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(registroData)
            })
                .then(response => {
                    formulario.reset()
                    if (response.ok) {
                        console.log('Registro agregado exitosamente');
                        window.location.reload()
                    } else {
                        console.error('Error al agregar registro');
                        window.location.reload()
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });


        function formatDateTime(date) {
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'short' });
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            const formattedDate = `${day} ${month.charAt(0).toUpperCase() + month.slice(1)} ${year} ${hours}:${minutes}:${seconds}`;
            return formattedDate;
        }

        const energyGraphDiv = document.getElementById('energy-graph');
        const reactiveEnergyGraphDiv = document.getElementById('reactive-energy-graph');
        const powerGraphDiv = document.getElementById('power-graph');
        const maximeterGraphDiv = document.getElementById('maximeter-graph');
        const reactivePowerGraphDiv = document.getElementById('reactive-power-graph');
        const voltageGraphDiv = document.getElementById('voltage-graph');
        const intensityGraphDiv = document.getElementById('intensity-graph');
        const powerFactorGraphDiv = document.getElementById('power-factor-graph');

        async function fetchData(url) {
            const response = await fetch(url);
            return response.json();
        }

        async function renderGraph(graphData, graphDiv) {
            Plotly.newPlot(graphDiv, JSON.parse(graphData), {});
        }

        async function generateGraph(graphUrl, graphDiv) {
            const data = await fetchData(graphUrl);
            renderGraph(data, graphDiv);
        }

        const energyTab = document.getElementById('pills-energy-tab');
        const reactiveEnergyTab = document.getElementById('pills-reactive-energy-tab');
        const powerTab = document.getElementById('pills-power-tab');
        const maximeterTab = document.getElementById('pills-maximeter-tab');
        const reactivePowerTab = document.getElementById('pills-reactive-power-tab');
        const voltageTab = document.getElementById('pills-voltage-tab');
        const intensityTab = document.getElementById('pills-intensity-tab');
        const powerFactorTab = document.getElementById('pills-power-factor-tab');

        energyTab.addEventListener('click', () => {
            generateGraph('/graphs/energy', energyGraphDiv);
        });

        reactiveEnergyTab.addEventListener('click', () => {
            generateGraph('/graphs/reactive energy', reactiveEnergyGraphDiv);
        });

        powerTab.addEventListener('click', () => {
            generateGraph('/graphs/power', powerGraphDiv);
        });

        maximeterTab.addEventListener('click', () => {
            generateGraph('/graphs/maximeter', maximeterGraphDiv);
        });

        reactivePowerTab.addEventListener('click', () => {
            generateGraph('/graphs/reactive power', reactivePowerGraphDiv);
        });

        voltageTab.addEventListener('click', () => {
            generateGraph('/graphs/voltage', voltageGraphDiv);
        });

        intensityTab.addEventListener('click', () => {
            generateGraph('/graphs/intensity', intensityGraphDiv);
        });

        powerFactorTab.addEventListener('click', () => {
            generateGraph('/graphs/power factor', powerFactorGraphDiv);
        });

        // Load initial graph
        generateGraph('/graphs/energy', energyGraphDiv);
    </script>
</body>

</html>